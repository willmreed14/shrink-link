<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Shortener</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
          rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous">
    <style>
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 0px;
            margin-top: 20px;
        }

        h1 {
            flex: 1;
            text-align: center;
            margin: 0;
        }

        .auth-controls {
            display: flex;
            align-items: center;
        }
    </style>
</head>

<body>
<div class="container">

    <!-- Container for header and auth controls -->
    <div class="header-container">
        <h1>Shrink Link</h1>
        <div class="auth-controls">
            <% if (!user) { %>
                <button id="signIn" class="btn btn-primary">Sign In</button>
            <% } else { %>
                <p id="welcomeMessage">Welcome, <strong><%= user.email %></strong>!</p>
                <button id="signOut" class="btn btn-danger">Sign Out</button>
            <% } %>
        </div>
    </div>

    

    <!-- Warning message for non-authenticated users -->
    <div style = "margin-top: 20px" id="authWarning" class="alert alert-warning">You must be signed in to shorten a URL.</div>

    <!-- URL Shortening Form -->
    <form id="shortenForm" class="my-4 d-flex">
        <label for="fullUrl" class="visually-hidden">Url</label>
        <input 
            required
            placeholder="Url" 
            type="url" 
            name="fullUrl" 
            id="fullUrl"
            class="form-control flex-grow-1 me-2">
        <button id="shrinkButton" class="btn btn-success" type="submit">Shrink</button>
    </form>    

    <!-- Table to display shortened URLs -->
    <div class="table-responsive">
        <table class="table table-striped table-responsive text-nowrap">
            <thead>
                <tr>
                    <th>Full URL</th>
                    <th>Short URL</th>
                    <th>Clicks</th>
                </tr>
            </thead>
            <tbody>
                <% shortUrls.forEach(shortUrl => { %>
                <tr>
                    <td>
                        <a href="<%= shortUrl.full %>" target="_blank" rel="noopener noreferrer">
                            <%= shortUrl.full.length > 30 ? shortUrl.full.slice(0, 30) + '...' : shortUrl.full %>
                        </a>
                    </td>
                    <td>
                        <a href="/<%= shortUrl.short %>" target="_blank" rel="noopener noreferrer">
                            <%= shortUrl.short %>
                        </a>
                    </td>
                    <td><%= shortUrl.clicks %></td>
                </tr>
                <% }) %>
            </tbody>
        </table>
    </div>
</div> <!-- Close Container -->

<!-- JavaScript -->
<script type="module">
    import { userManager, signOutRedirect } from "/main.js";

    async function fetchUserShortUrls(token) {
        try {
            const response = await fetch("/user/shortUrls", {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            });

            if (!response.ok) {
                throw new Error("Failed to fetch user URLs");
            }

            const userShortUrls = await response.json();
            console.log("‚úÖ Fetched user URLs:", userShortUrls);

            // ‚úÖ Populate table with user's URLs
            const tableBody = document.querySelector("tbody");
            tableBody.innerHTML = ""; // Clear existing rows

            userShortUrls.forEach(shortUrl => {
                const newRow = document.createElement("tr");
                newRow.innerHTML = `
                    <td><a href="${shortUrl.full}" target="_blank">${shortUrl.full.length > 30 ? shortUrl.full.slice(0, 30) + '...' : shortUrl.full}</a></td>
                    <td><a href="/${shortUrl.short}" target="_blank">${shortUrl.short}</a></td>
                    <td>${shortUrl.clicks}</td>
                `;
                tableBody.appendChild(newRow);
            });

        } catch (error) {
            console.error("‚ùå Error fetching user URLs:", error);
        }
    }

    async function checkAuthStatus() {
    const user = await userManager.getUser();
    if (user) {
        console.log("‚úÖ User is signed in:", user);
        localStorage.setItem("access_token", user.access_token);
        localStorage.setItem("id_token", user.id_token);
        localStorage.setItem("user_email", user.profile.email);

        const signInButton = document.getElementById("signIn");
        const authWarning = document.getElementById("authWarning");
        const signOutButton = document.getElementById("signOut");
        const welcomeMessage = document.getElementById("welcomeMessage");

        if (signInButton) signInButton.style.display = "none";
        if (authWarning) authWarning.style.display = "none";
        if (signOutButton) signOutButton.style.display = "block";

        // ‚úÖ Fix: Ensure `welcomeMessage` exists before setting `textContent`
        if (welcomeMessage) {
            welcomeMessage.textContent = `Welcome, ${user.profile.email}!`;
        } else {
            console.warn("‚ö†Ô∏è Warning: welcomeMessage element NOT found in DOM");
        }

        // ‚úÖ Fetch user links after sign-in
        fetchUserShortUrls(user.access_token);
    }
}


    // ‚úÖ Handle Sign-In Button Click
    const signInButton = document.getElementById("signIn");
    console.log("üîç Checking Sign-In Button:", signInButton);
    if (signInButton) {
        signInButton.addEventListener("click", async () => {
            console.log("üîç Sign-In button clicked");
            await userManager.signinRedirect();
        });
    } else {
        console.error("‚ùå Sign-In Button NOT FOUND in the DOM");
    }

    // ‚úÖ Handle Sign-Out Button Click
    const signOutButton = document.getElementById("signOut");
    if (signOutButton) {
        signOutButton.addEventListener("click", async () => {
            console.log("üîç Sign-Out button clicked");
            await signOutRedirect();
        });
    } else {
        console.error("‚ùå Sign-Out Button NOT FOUND in the DOM");
    }

    // ‚úÖ Handle URL Shortening Without Reloading the Page
    document.getElementById("shortenForm").addEventListener("submit", async (event) => {
        event.preventDefault(); // ‚úÖ Prevent page reload

        const fullUrl = document.getElementById("fullUrl").value;
        if (!fullUrl) {
            alert("Please enter a valid URL.");
            return;
        }

        try {
            const token = localStorage.getItem("access_token");
            const response = await fetch("/shortUrls", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ fullUrl })
            });

            if (!response.ok) {
                throw new Error("Failed to shorten URL.");
            }

            const newShortUrl = await response.json();
            console.log("‚úÖ New Short URL Created:", newShortUrl);

            // ‚úÖ Add new shortened URL to the table dynamically
            const tableBody = document.querySelector("tbody");
            const newRow = document.createElement("tr");
            newRow.innerHTML = `
                <td><a href="${newShortUrl.full}" target="_blank">${newShortUrl.full.length > 30 ? newShortUrl.full.slice(0, 30) + '...' : newShortUrl.full}</a></td>
                <td><a href="/${newShortUrl.short}" target="_blank">${newShortUrl.short}</a></td>
                <td>${newShortUrl.clicks}</td>
            `;
            tableBody.appendChild(newRow);

            // ‚úÖ Clear input field after submission
            document.getElementById("fullUrl").value = "";

        } catch (error) {
            console.error("‚ùå Error shortening URL:", error);
            alert("Failed to shorten URL. Please try again.");
        }
    });

    checkAuthStatus();
</script>


</body>
</html>
